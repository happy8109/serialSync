# SerialSync 架构设计

## 项目愿景与核心目标

SerialSync 致力于打造一个基于串口的双机文件共享/同步平台，支持点对点文件传输和字符传输（聊天），适用于无网络环境下的工业、实验室、嵌入式等场景。

### 主要目标：
- **串口双机文件共享/同步**：让两台设备通过串口实现类似“网盘/同步盘”的文件互通，支持自动/手动同步、目录级文件管理。
- **点对点文件传输**：支持用户主动选择文件，通过串口点对点发送，适合临时文件交换、批量传输。
- **点对点字符传输（聊天）**：支持实时文本消息传递，实现简易聊天或命令交互。
- **跨平台、低门槛、易用性**：让没有网络环境的设备也能方便地进行文件和消息同步。

> 提示：后续 UI 和高级功能开发应始终聚焦于上述高层应用目标，避免只关注底层协议和工具实现。

---

## 核心功能

SerialSync 项目有两大核心功能，所有协议、架构与实现均围绕这两点展开：

1. **文字传输**：支持短消息、命令、聊天等字符数据的可靠传输（短包协议）。
2. **文件传输**：支持大文件、二进制数据的高效分块传输、自动确认、进度统计等（分块/扩展协议）。

请在开发、维护、扩展时始终牢记这两大核心功能，避免遗忘或偏离项目主线。

## 主要模块结构

- `src/core/serial/SerialManager.js`：核心串口与协议实现，事件驱动，负责协议解析、会话管理、分块传输。
- `src/cli.js`：命令行界面，负责用户交互、命令解析、进度显示。
- `src/utils/`：工具与日志，统一日志输出、错误处理。
- `config/`：配置文件，集中管理串口、传输、目录等参数。
- `logs/`：日志文件，记录操作与安全审计。
- `docs/`：开发文档（架构、协议、接口、CLI、进度等）。

## 测试环境说明

- 当前所有开发与联调均基于**虚拟串口连接**（如 com0com、vspd 等虚拟串口对）。
- send 命令（短包协议）已在该环境下多次验证通畅，收发无误。
- 如遇文件传输等问题，优先排查协议实现、事件流、包格式等逻辑，不再怀疑物理链路。
- 如后续测试环境有变化，请及时同步更新本说明。

## 后续计划

- 详见 docs/development-progress.md 下阶段开发计划。
- 重点关注多文件队列、性能优化、Web UI、用户体验提升等方向。 

---

## 后端服务协议设计与多端兼容性

为确保 SerialSync 后端服务具备更高的通用性和兼容性，推荐采用“RESTful API + WebSocket”组合协议，既能对接 Web UI，也能通过 API 与桌面应用（如 WinForms、Electron、Qt 等）无缝集成。

### 推荐架构
- **RESTful API**：适合所有平台（Web、桌面、移动、脚本等）进行命令调用、状态查询、文件上传/下载。
- **WebSocket**：适合推送实时事件（如进度、日志、文件请求、状态变更等），提升前端体验。
- **文件传输**：建议用标准 HTTP(S) multipart/form-data 或流式下载接口，兼容所有主流前端。

### 设计建议
- API 设计遵循 RESTful 风格，如：
  - `POST /api/connect`、`POST /api/sendfile`、`GET /api/status`、`GET /api/progress`、`POST /api/sendmsg` 等
- 事件推送用 WebSocket，如：
  - `ws://localhost:3000/ws`，推送 progress、fileRequest、log、error 等事件
- 接口文档标准化，建议采用 OpenAPI/Swagger 规范，便于多端对接和自动生成客户端代码
- 可选身份认证/安全机制（如 JWT、Token、IP 白名单等）

### 桌面应用对接注意事项
- .NET（WinForms/WPF）、Electron、Qt、Java、Python 等均原生支持 HTTP/WebSocket
- 避免仅浏览器支持的协议（如 SSE），优先用 WebSocket
- 文件传输接口要支持大文件分块/断点续传（如有需求）

### 典型多端对接流程（以 WinForms 为例）
1. **连接串口**：`POST /api/connect`，参数为串口号、波特率等
2. **发送/接收文件**：`POST /api/sendfile` 上传文件，`GET /api/receivefile` 下载文件
3. **实时进度/事件**：通过 WebSocket 订阅进度、日志、文件请求等事件
4. **状态查询**：`GET /api/status` 查询当前连接、任务、速率等

### 结论
- RESTful API + WebSocket 是最通用、跨平台、易维护的服务协议组合，适合 Web、桌面、移动等多端对接。
- 只要接口标准化，任何支持 HTTP/WebSocket 的前端都能无缝对接本项目。
- 此方案为后续多端开发（Web UI、WinForms、Electron、Qt 等）提供坚实基础。

--- 

---

## 2025-07-11 设计进展与未来规划

### CLI 与协议层
- CLI 全面 inquirer 化，命令、参数、确认、路径输入均为交互式体验，历史输入流冲突、提示符丢失等问题彻底解决。
- autospeed、receivefile 等命令体验优化，参数提示、另存为等细节适配未来 UI 场景。
- SerialManager 事件驱动架构，接口完整，进度、丢块、重试等统计信息丰富，满足 CLI/UI/自动化多场景需求。

### 后端服务与多端兼容
- 推荐后端采用 RESTful API + WebSocket 组合协议，兼容 Web UI、桌面应用（WinForms、Electron、Qt 等），接口标准化，便于多端集成。
- 目录结构建议分层聚合，api/、ws/、services/、utils/ 等，避免 server.js 过于臃肿。
- 典型流程、接口建议、对接注意事项已补充进文档。

### Web UI 现状与建议
- 已有基础 Web UI，支持串口连接、参数配置、数据收发、日志。
- 建议后续扩展文件传输、进度条、另存为、队列等 UI，保持与 CLI 一致的交互体验。
- 后端需补充/完善 RESTful API 和 WebSocket 推送，覆盖所有 CLI 能力。

### 多文件队列与并发
- 串口速率有限，无需并发，推荐多文件队列由 CLI/UI/脚本层实现，SerialManager 保持单文件传输、事件驱动。
- 文档已补充多文件队列实现建议和伪代码。

### 项目愿景回归
- 项目目标聚焦“串口双机文件共享/同步、点对点文件/字符传输（聊天）”，不仅仅是底层协议和工具。
- 文档和开发计划已同步突出这一愿景，后续开发应聚焦于高层应用目标。

--- 

---

## 文件同步队列与任务管理设计（2025-07-15补充）

### 1. 高层文件队列系统
- 所有文件相关传输（同步、点对点、API/外部请求）统一纳入 FileTransferQueue 进行调度。
- 队列支持任务入队、出队、暂停、恢复、取消，底层 SerialManager 只负责单文件传输。
- 队列任务类型区分“同步任务”、“点对点传输”、“API请求”等。

### 2. 同步任务的概念
- 每个同步任务独立可控（新建、修改、启用、停止、删除）。
- 任务包含：需同步的文件/文件夹路径、同步方向、同步策略、递归、排除规则、优先级、同步周期等。

#### 任务数据结构示例：
```js
const syncTask = {
  id: 'task1',
  name: '文档同步',
  enabled: true,
  srcPath: 'D:/docs',
  dstPath: '/mnt/docs',
  direction: 'A->B',
  strategy: 'mtime', // 冲突策略：以最近修改时间为准
  recursive: true,   // 是否递归子目录
  exclude: ['*.tmp', 'node_modules'],
  priority: 10,      // 优先级，数值越大优先级越高
  schedule: '0 */10 * * * *', // 同步周期，cron表达式或定时秒数
};
```

### 3. 队列调度与优先级
- FileTransferQueue 支持按任务优先级调度，高优先级任务先执行。
- 支持定时/周期同步（如每10分钟自动同步），可通过 schedule 字段配置。
- 队列可动态插入/调整任务，支持暂停/恢复/取消。

### 4. 同步流程与冲突策略
- 递归扫描目录，生成文件状态清单（含 mtime/hash/size/相对路径）。
- 双方交换清单，比对差异，按优先级和同步周期生成同步队列。
- 冲突处理：以最近修改日期为准，新文件覆盖旧文件。
- 日志记录所有同步、冲突、覆盖等操作。

### 5. 典型伪代码
```js
// 任务管理
const syncTask = { ... };
// 队列调度
FileTransferQueue.enqueue({
  type: 'sync',
  taskId: syncTask.id,
  file: 'D:/docs/a.txt',
  action: 'upload',
  priority: syncTask.priority
});
// 队列统一调度，按优先级和周期执行
FileTransferQueue.processNext();
```

--- 